---
title: "Final Report"
author: "Stephen Reagin"
date: "2023-12-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
setwd("/Users/stephenreagin/Desktop/USD/ADS_506_final_project/final_project/datasets/")

library(forecast)
#install.packages('GGally')
library(fpp3)
library(tidyverse)
library(dplyr)

transactions_df <- read.csv("daily_total_transactions.csv")
transactions_df$date <- as.Date(transactions_df$date)

transactions_tsibble <- as_tsibble(transactions_df, index=date)

#training and validation data splits
train_transactions_tsibble <- transactions_tsibble |> 
  slice(0:(length(transactions_df$transactions)-90))
valid_transactions_tsibble <- transactions_tsibble |> slice(n()-89:0)

plot(x=transactions_tsibble$date, y=transactions_tsibble$transactions,
     xlab="Date",ylab="Daily Transactions", main='Daily Transactions over Time (all days)')



######## remove holidays and Sundays
nonspecial_df <- subset(transactions_tsibble, (isSunday == 0) & (isHoliday == 0))
special_df <- subset(transactions_tsibble, (isSunday == 1) | (isHoliday == 1))

nonspecial_df$X <- 1:length(nonspecial_df$X)
nonspecial_df <- as_tsibble(nonspecial_df, index=date) 

train_nonspecial_df <- nonspecial_df |> slice(0:(length(nonspecial_df$transactions)-90))
valid_nonspecial_df <- nonspecial_df |> slice(n()-89:0)

plot(x=nonspecial_df$date, y=nonspecial_df$transactions, xlab="Date",ylab="Daily Transactions", 
     main='Daily Transactions over Time (no Sundays or holidays)')
```

## Linear Regression Models

### Linear Regression - All Days

```{r}
#fit the model
fit_lm <- train_transactions_tsibble |> model(lm = TSLM(transactions ~ TAVG + 
                PRCP + TMIN + isSunday + isHoliday + trend() + season()))
#forecast using validation data
fc_lm <- forecast(fit_lm, new_data = valid_transactions_tsibble)

#transactions_tsibble |> autoplot(transactions) + autolayer(fc_lm)
transactions_tsibble |> autoplot(transactions,color='darkgray') + autolayer(fc_lm, level=NULL) +
  labs(title="Linear Regression 90-day forecast (all days included)")

sum(fc_lm$.mean) / sum(valid_transactions_tsibble$transactions)

accuracy(fc_lm$.mean, valid_transactions_tsibble$transactions)
```

### Linear Regression - No Sundays or Holidays

```{r}
fit_lm <- nonspecial_df |> model(lm = TSLM(transactions ~ TAVG + PRCP + TMIN + TMAX + 
                                             trend() + season()))
fc_lm <- forecast(fit_lm, new_data = valid_nonspecial_df)

nonspecial_df |> autoplot(transactions, color='darkgray')  + 
  autolayer(fc_lm, level=NULL) +
  labs(title='Transactions volume 2021 - 2023, with 90-day prediction (linear regression)', 
       x='Date', ylab='Transactions') 

sum(fc_lm$.mean) / sum(valid_nonspecial_df$transactions)

accuracy(fc_lm$.mean, valid_nonspecial_df$transactions)

```


## ARIMA Models

The (P,D,Q) values for the ARIMA models were automatically generated by running `ARIMA(season_adjust, stepwise=FALSE, approx=FALSE)` and manually coding the results so as to reduce runtime in subsequent notebook renderings.

### ARIMA - All Days

```{r}
fit <- train_transactions_tsibble |> model(ARIMA(transactions ~ pdq(0,0,2) + PDQ(0,1,1)))
report(fit)

fc <- fit |> forecast(h=180) 

transactions_tsibble |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL)

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(fc$.mean[1:90],valid_transactions_tsibble$transactions)

```

### ARIMA - No Sundays or holidays

```{r}
#need to redefine tsibble objects to key on a dummy index

nonspecial_df <- subset(transactions_tsibble, (isSunday == 0) & (isHoliday == 0))
special_df <- subset(transactions_tsibble, (isSunday == 1) | (isHoliday == 1))

nonspecial_df$X <- 1:length(nonspecial_df$X)
nonspecial_df <- as_tsibble(nonspecial_df, index=X) 

train_nonspecial_df <- nonspecial_df |> slice(0:(length(nonspecial_df$transactions)-90))
valid_nonspecial_df <- nonspecial_df |> slice(n()-89:0)
```

```{r}
fit <- train_nonspecial_df |> model(ARIMA(transactions ~ pdq(4,1,2)))
report(fit)

fc <- fit |> forecast(h=180) 

nonspecial_df |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL)

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(fc$.mean[1:90], valid_nonspecial_df$transactions)

```

## ETS

### ETS - All Days
```{r}
ets_fit <- train_transactions_tsibble |> model(ETS(transactions))
report(ets_fit)

ets_fc <- ets_fit |> forecast(h=180)
fitted_ets <- ets_fit |> augment()

#training
accuracy(fitted_ets$.fitted, train_transactions_tsibble$transactions)
#validation
accuracy(ets_fc$.mean[1:90], valid_transactions_tsibble$transactions)

ets_fc |> autoplot(transactions_tsibble, level=NULL, color='red') + 
  ggtitle("ETS Model (ANA) with 90-day forecasts") +
  geom_line(data=ets_fit |> augment(), aes(y=.fitted), color='blue', lty=2)

```

### ETS - no Sundays or Holidays

```{r}
ets_fit <- train_nonspecial_df |> model(ETS(transactions))
report(ets_fit)

ets_fc <- ets_fit |> forecast(h=180)
fitted_ets <- ets_fit |> augment()

accuracy(fitted_ets$.fitted, train_nonspecial_df$transactions)
accuracy(ets_fc$.mean[1:90], valid_nonspecial_df$transactions)

ets_fc |> autoplot(nonspecial_df, level=NULL, color='red') + 
  ggtitle("ETS Model (ANN) with 90-day forecasts") +
  geom_line(data=ets_fit |> augment(), aes(y=.fitted), color='blue', lty=2)

```









## STL + ETS

### STL + ETS - All Days

```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(7) + season(365), robust=TRUE),
                    ETS(season_adjust ~ season("N")))

dcmp_ets <- train_transactions_tsibble |> model(dcmp_spec) 
report(dcmp_ets)

fc <-  dcmp_ets |> forecast(h=180)


transactions_tsibble |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL)

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions[1:90])

accuracy(fc$.mean[1:90], valid_transactions_tsibble$transactions[1:90])

```

### STL + ETS - No Sundays or Holidays

```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(6) + season(294), robust=TRUE),
                                 ETS(season_adjust ~ season("N")))

dcmp_ets <- train_nonspecial_df |> model(dcmp_spec) 
report(dcmp_ets)

fc <-  dcmp_ets |> forecast(h=180)

nonspecial_df |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL)

sum(fc$.mean[1:90]) / sum(valid_nonspecial_df$transactions[1:90])

accuracy(fc$.mean[1:90], valid_nonspecial_df$transactions[1:90])
```



## STL + ARIMA
### STL + ARIMA - All Days
```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(7) + season(365), robust=TRUE),
                                 ARIMA(season_adjust, stepwise=FALSE, approx=FALSE))

dcmp_arima <- train_transactions_tsibble |> model(dcmp_spec) 
report(dcmp_arima)

fc <-  dcmp_arima |> forecast(h=180)

transactions_tsibble |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL)
#fc |> autoplot(train_transactions_tsibble, level=NULL)

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(fc$.mean[1:90], valid_transactions_tsibble$transactions)

```

### STL + ARIMA - No Sundays or Holidays
```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(6) + season(294), robust=TRUE),
                                 ARIMA(season_adjust, stepwise=FALSE, approx=FALSE))

dcmp_arima <- train_nonspecial_df |> model(dcmp_spec) 
report(dcmp_arima)

fc <-  dcmp_arima |> forecast(h=180)

nonspecial_df |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL)
#fc |> autoplot(train_nonspecial_df, level=NULL)

sum(fc$.mean[1:90]) / sum(valid_nonspecial_df$transactions)

accuracy(fc$.mean[1:90], valid_nonspecial_df$transactions)
#```