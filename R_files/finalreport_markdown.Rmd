---
title: "Final Report Models"
author: "Stephen Reagin"
date: "2023-12-10"
output: html_document
---

This file contains R code to model parking meter activity using various time series models:

* Linear Regression
* ARIMA
* ETS (exponential smoothing)
* STL + ETS (seasonal decomposition with ETS)
* STL + ARIMA (seasonal decomposition with ARIMA)
* Baseline models
  * Mean forecast
  * Naive forecast
  * Drift forecast

For every model there are two versions which correspond with two datasets:

* All days included
* Sundays and holidays excluded


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
setwd("/Users/stephenreagin/Desktop/USD/ADS_506_final_project/final_project/datasets/")

library(forecast)
#install.packages('GGally')
library(fpp3)
library(tidyverse)
library(dplyr)

transactions_df <- read.csv("daily_total_transactions.csv")
transactions_df$date <- as.Date(transactions_df$date)

transactions_tsibble <- as_tsibble(transactions_df, index=date)

#training and validation data splits
train_transactions_tsibble <- transactions_tsibble |> 
  slice(0:(length(transactions_df$transactions)-90))
valid_transactions_tsibble <- transactions_tsibble |> slice(n()-89:0)

plot(x=transactions_tsibble$date, y=transactions_tsibble$transactions,
     xlab="Date",ylab="Daily Transactions", main='Daily Transactions over Time (all days)')



######## remove holidays and Sundays
nonspecial_df <- subset(transactions_tsibble, (isSunday == 0) & (isHoliday == 0))
special_df <- subset(transactions_tsibble, (isSunday == 1) | (isHoliday == 1))

nonspecial_df$X <- 1:length(nonspecial_df$X)
nonspecial_df <- as_tsibble(nonspecial_df, index=date) 

train_nonspecial_df <- nonspecial_df |> slice(0:(length(nonspecial_df$transactions)-90))
valid_nonspecial_df <- nonspecial_df |> slice(n()-89:0)

plot(x=nonspecial_df$date, y=nonspecial_df$transactions, xlab="Date",ylab="Daily Transactions", 
     main='Daily Transactions over Time (no Sundays or holidays)')
```


## Linear Regression Models

### Linear Regression - All Days

```{r}
#fit the model
fit_lm <- train_transactions_tsibble |> model(lm = TSLM(transactions ~ TAVG + 
                PRCP + TMIN + isSunday + isHoliday + trend() + season()))
report(fit_lm)
fit_lm |> gg_tsresiduals() + labs("Linear Regression training errors")

#forecast using validation data
fc_lm <- forecast(fit_lm, new_data = valid_transactions_tsibble)

#transactions_tsibble |> autoplot(transactions) + autolayer(fc_lm)
transactions_tsibble |> autoplot(transactions,color='darkgray') + autolayer(fc_lm, level=NULL) +
  labs(title="Linear Regression 90-day forecast (all days included)", xlab="Date",ylab="Transactions")

sum(fc_lm$.mean) / sum(valid_transactions_tsibble$transactions)

accuracy(fit_lm)
accuracy(fc_lm, valid_transactions_tsibble)

```

### Linear Regression - No Sundays or Holidays

```{r}
fit_lm <- nonspecial_df |> model(lm = TSLM(transactions ~ TAVG + PRCP + TMIN + TMAX + 
                                             trend() + season()))

report(fit_lm)

fc_lm <- forecast(fit_lm, new_data = valid_nonspecial_df)

nonspecial_df |> autoplot(transactions, color='darkgray')  + 
  autolayer(fc_lm, level=NULL) +
  labs(title='Transactions volume 2021 - 2023, with 90-day prediction (linear regression)', 
       x='Date', ylab='Transactions') 

sum(fc_lm$.mean) / sum(valid_nonspecial_df$transactions)

accuracy(fit_lm)
accuracy(fc_lm, valid_nonspecial_df)


```


## ARIMA Models

The (P,D,Q) values for the ARIMA models were automatically generated by running `ARIMA(season_adjust, stepwise=FALSE, approx=FALSE)` and manually coding the results so as to reduce runtime in subsequent notebook renderings.

### ARIMA - All Days

```{r}
fit <- train_transactions_tsibble |> model(ARIMA(transactions ~ pdq(0,0,2) + PDQ(0,1,1)))
report(fit)
fit |> gg_tsresiduals() + labs("ARIMA training errors")

fc <- fit |> forecast(h=180) 

transactions_tsibble |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) +
  labs(title='All Days, transactions volume, 180 day forecast (ARIMA)', 
       x='Date', ylab='Transactions') 

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(fit)
accuracy(fc[1:90,], valid_transactions_tsibble)

```

### ARIMA - No Sundays or holidays

```{r}
#need to redefine tsibble objects to key on a dummy index

nonspecial_df <- subset(transactions_tsibble, (isSunday == 0) & (isHoliday == 0))
special_df <- subset(transactions_tsibble, (isSunday == 1) | (isHoliday == 1))

nonspecial_df$X <- 1:length(nonspecial_df$X)
nonspecial_df <- as_tsibble(nonspecial_df, index=X) 

train_nonspecial_df <- nonspecial_df |> slice(0:(length(nonspecial_df$transactions)-90))
valid_nonspecial_df <- nonspecial_df |> slice(n()-89:0)
```

```{r}
fit <- train_nonspecial_df |> model(ARIMA(transactions ~ pdq(4,1,2)))
report(fit)
fit |> gg_tsresiduals() + labs("ARIMA training errors")

fc <- fit |> forecast(h=180) 

nonspecial_df |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) + 
  labs(title='No Sundays/Holidays, transactions volume, 180 day forecast (ARIMA)', 
       x='Date', ylab='Transactions') 

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(fit)
accuracy(fc[1:90,], valid_nonspecial_df)


```

## ETS

### ETS - All Days
```{r}
ets_fit <- train_transactions_tsibble |> model(ETS(transactions))
report(ets_fit)

ets_fit |> gg_tsresiduals() + labs("ETS training errors")

ets_fit |> components() |> autoplot()

ets_fc <- ets_fit |> forecast(h=180)
fitted_ets <- ets_fit |> augment()

#training
accuracy(fitted_ets$.fitted, train_transactions_tsibble$transactions)
#validation
accuracy(ets_fc$.mean[1:90], valid_transactions_tsibble$transactions)

ets_fc |> autoplot(transactions_tsibble, level=NULL, color='red') + 
  ggtitle("ETS Model (ANA) with 90-day forecasts") +
  geom_line(data=ets_fit |> augment(), aes(y=.fitted), color='blue', lty=2)

sum(ets_fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(ets_fit)
accuracy(ets_fc[1:90,], valid_transactions_tsibble)



```

### ETS - no Sundays or Holidays

```{r}
ets_fit <- train_nonspecial_df |> model(ETS(transactions))
report(ets_fit)
ets_fit |> gg_tsresiduals() + labs("ETS training errors")

ets_fit |> components() |> autoplot()

ets_fc <- ets_fit |> forecast(h=180)
fitted_ets <- ets_fit |> augment()

ets_fc |> autoplot(nonspecial_df, level=NULL, color='red') + 
  ggtitle("ETS Model (ANN) with 90-day forecasts") +
  geom_line(data=ets_fit |> augment(), aes(y=.fitted), color='blue', lty=2)

sum(ets_fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(ets_fit)
accuracy(ets_fc[1:90,], valid_nonspecial_df)

```









## STL + ETS

### Decomposition of the All Days dataset
```{r}
transactions_tsibble %>% model(STL(transactions ~ season(7) +
                                     season(365), robust=TRUE)) %>% components() |>  autoplot()
```

### Decomposition of the No Sundays, No Holidays dataset

The new weekly season is 6 days, and the annual season is 294 (365 - 52 Sundays - 19 holidays = 294)
```{r}
nonspecial_df %>% model(STL(transactions ~ season(6) +
                                     season(294), robust=TRUE)) %>% components() |>  autoplot()
```



### STL + ETS - All Days

```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(7) + season(365), robust=TRUE),
                    ETS(season_adjust))

dcmp_ets <- train_transactions_tsibble |> model(dcmp_spec) 
report(dcmp_ets)
dcmp_ets |> gg_tsresiduals() + labs("STL + ETS training errors")

fc <-  dcmp_ets |> forecast(h=180)


transactions_tsibble |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) +
  labs(title='All Days, transactions volume, 180 day forecast w/ STL + ETS(A,Ad,A)', 
       x='Date', ylab='Transactions') 

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions[1:90])

accuracy(dcmp_ets)
accuracy(fc[1:90,], valid_nonspecial_df)

```

### STL + ETS - No Sundays or Holidays

```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(6) + season(294), robust=TRUE),
                                 ETS(season_adjust))

dcmp_ets <- train_nonspecial_df |> model(dcmp_spec) 
report(dcmp_ets)
dcmp_ets |> gg_tsresiduals() + labs("STL + ETS training errors")


fc <-  dcmp_ets |> forecast(h=180)

nonspecial_df |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) +
  labs(title='No Sundays/Holidays, transactions volume, 180 day forecast w/ STL + ETS(A,Ad,N)', 
       x='Date', ylab='Transactions') 

sum(fc$.mean[1:90]) / sum(valid_nonspecial_df$transactions[1:90])

accuracy(dcmp_ets)
accuracy(fc[1:90,], valid_nonspecial_df)
```



## STL + ARIMA
### STL + ARIMA - All Days
```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(7) + season(365), robust=TRUE),
                                 ARIMA(season_adjust, stepwise=FALSE, approx=FALSE))

dcmp_arima <- train_transactions_tsibble |> model(dcmp_spec) 
report(dcmp_arima)
dcmp_arima |> gg_tsresiduals() + labs("STL + ARIMA training errors")

fc <-  dcmp_arima |> forecast(h=180)

transactions_tsibble |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) + 
  labs(title='All Days, transactions, 180 day forecast (STL + ARIMA)', 
       x='Date', ylab='Transactions') 

sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)

accuracy(dcmp_arima)
accuracy(fc[1:90,], valid_transactions_tsibble)

```

### STL + ARIMA - No Sundays or Holidays
```{r}
dcmp_spec <- decomposition_model(STL(transactions ~ season(6) + season(294), robust=TRUE),
                                 ARIMA(season_adjust, stepwise=FALSE, approx=FALSE))

dcmp_arima <- train_nonspecial_df |> model(dcmp_spec) 
report(dcmp_arima)
dcmp_arima |> gg_tsresiduals() + labs("STL + ARIMA training errors")

fc <-  dcmp_arima |> forecast(h=180)

nonspecial_df |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) +
  labs(title='No Sundays/Holidays Days, transactions, 180 day forecast (STL + ARIMA)', 
       x='Date', ylab='Transactions') 


sum(fc$.mean[1:90]) / sum(valid_nonspecial_df$transactions)

accuracy(dcmp_arima)
accuracy(fc[1:90,], valid_nonspecial_df)
```

## Establishing a baseline with Mean, Naive, Drift models

### Baseline - All Days

```{r}
fit <- train_transactions_tsibble |> model(
  mean = MEAN(transactions),
  naive = NAIVE(transactions),
  drift = RW(transactions ~ drift()))

fc <- fit |> forecast(h=180)
transactions_tsibble |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) +
  labs(title='All Days, transactions volume, 180 day forecast (baseline)', 
       x='Date', ylab='Transactions') 

accuracy(fit)
accuracy(fc[1:90,], valid_transactions_tsibble)
sum(fc$.mean[1:90]) / sum(valid_transactions_tsibble$transactions)
accuracy(fc[181:270,], valid_transactions_tsibble)
sum(fc$.mean[181:270]) / sum(valid_transactions_tsibble$transactions)
accuracy(fc[361:450,], valid_transactions_tsibble)
sum(fc$.mean[361:450]) / sum(valid_transactions_tsibble$transactions)
```

### Baseline - No Sundays or Holidays

```{r}
fit <- train_nonspecial_df |> model(
  mean = MEAN(transactions),
  naive = NAIVE(transactions),
  drift = RW(transactions ~ drift())) 

fc <- fit |> forecast(h=180)
nonspecial_df |> autoplot(transactions, color='darkgray') + autolayer(fc, level=NULL) + 
  labs(title='No Sundays/Holidays, transactions volume, 180 day forecast (baseline)', 
       x='Date', ylab='Transactions') 

accuracy(fit)
accuracy(fc[1:90,], valid_nonspecial_df)
sum(fc$.mean[1:90]) / sum(valid_nonspecial_df$transactions)
accuracy(fc[181:270,], valid_nonspecial_df)
sum(fc$.mean[181:270]) / sum(valid_nonspecial_df$transactions)
accuracy(fc[361:450,], valid_nonspecial_df)
sum(fc$.mean[361:450]) / sum(valid_nonspecial_df$transactions)
```


# Additional visuals

### Weekly Transactions, Holidays, Precipitation
```{r}
library(xts)

num_transactions.ts <- ts(transactions_df$transactions, start=c(2020,295), freq=365)

#creating time series vectors
total_transactions.xts <- xts(transactions_df$transactions, order.by = transactions_df$date)
isHoliday.xts <- xts(transactions_df$isHoliday, order.by = transactions_df$date)
precip.xts <- xts(transactions_df$PRCP, order.by = transactions_df$date)
tavg.xts <- xts(transactions_df$TAVG, order.by = transactions_df$date)


weekly_transactions.xts <- apply.weekly(total_transactions.xts, sum)
weekly_precip.xts <- apply.weekly(precip.xts, sum)
weekly_tavg.xts <- apply.weekly(tavg.xts, mean)

#weekly transactions with holidays
plot.xts(weekly_transactions.xts, main='Weekly Transactions over Time',ylim=c(0,150000)) 
lines(weekly_precip.xts * 1000 + 20000, col='blue', lty=2, lwd=1) 
points(isHoliday.xts * 100000-1, pch = 20, col='purple') 
addLegend("topleft",c('Weekly transactions', "Rainfall",'Holiday'), lty=c(1,2,3),
          col=c('black','blue','purple'), lwd=c(1,1,2))
```

### Relationship with Average Temperature

```{r}
transactions_tsibble |> ggplot(aes(x=TAVG, y=transactions)) + geom_point() + 
  geom_smooth(method = 'lm', se=FALSE) + labs(title="Transactions as a function of Temperature (C)")

nonspecial_df |> ggplot(aes(x=TAVG, y=transactions)) + geom_point() + 
  geom_smooth(method = 'lm', se=FALSE) + labs(title = "Transactions as a Function of Temperature (Sundays & Holidays removed)")

```

## ACF and Difference plots

### ACF - All Days
```{r}
transactions_tsibble |> ACF(difference(transactions), lag_max = 180) |> autoplot()

transactions_tsibble |> autoplot(difference(transactions, lag=7))

```

### ACF - No Sundays, No Holidays
```{r}
nonspecial_df |> ACF(difference(transactions), lag_max = 180) |> autoplot()

nonspecial_df |> autoplot(difference(transactions, lag=1))
```